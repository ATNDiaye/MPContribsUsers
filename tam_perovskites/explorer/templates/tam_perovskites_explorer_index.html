{% extends "../../webtzite/templates/base/header_footer.html" %}
{% load staticfiles %}

{% block title %} Tam Perovskites {% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href='{% static "js/components/backgrid/lib/backgrid.css" %}' charset="utf-8">
<link rel="stylesheet" href='{% static "js/components/json-human/css/json.human.css" %}' charset="utf-8">
{% endblock extra_css %}

{% block content %}

{% if alert %}
<div class="alert alert-warning alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
  {{ alert }}
</div>

{% else %}

<style>
.backgrid .string-cell { text-align: center; }
.backgrid tbody tr:hover { background-color: #f9f9f9; }
.jh-root:hover { cursor: default; }
</style>

<div class="container">
    <div class="row">
        <h2>{{ title }}</h2>
        <div class="col-md-6">
        <h3>Provenance</h3>
        <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#provenance">Show/Hide</button>
        <div id="provenance"; class= "collapse in">
            {{ provenance|safe }}
        </div>
        </div>
        
        <div class="col-md-6">
        <h3>Abbreviations</h3>
            <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#abbrevs">Show/Hide</button>
            <div id="abbrevs" class= "collapse in">
                {{ abbreviations|safe }}
            </div>
        </div>
    </div>
    <div class="row">
        <h3>Data</h3>
        <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#table">Show/Hide</button>
           <div id="table" class= "collapse in">
            {{ table|safe }}
           </div>
    </div>
    
    <div class = "row">
    <h3>Graph</h3>
     <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#plot">Show/Hide</button>
     <div id= "plot"; class= "collapse in">
      <div id="navs" style="display: inline">
      
        
        
      <select id="yChoose" style="width:20%" onchange="handleYChange()">
      <option value="" disabled="" selected="">Choose an Y-Axis</option></select>

      <p style="display: inline">as a function of</p>

      <select id="xChoose" style="width:20%" onchange="handleXChange()">
      <option value="" disabled="" selected="">Choose an X-Axis</option></select></div>
      <div id = "graph"></div>  
        </div>
    </div>
</div>

<script>
requirejs(['main'], function() {
    require(["backgrid"], function() {
        $(document).ready(function() {
            $("div#abbrevs").on("click", "div > table > tbody > tr", function() {
                var column = $("> th", this).text();
                $("."+column).toggleClass("renderable");
                console.log(column);
            });
        });
    });
});
</script>

<script>
var xKey = "";
var yKey = "";
var xTitle;
var yTitle;
var xVals = []; 
var yVals = [];
var rows = [];
var keys = [];
var names = [];

requirejs(['main'], function() {
    require(["plotly"], function(Plotly) {
    $(document).ready(function() {
        console.log(window.tables.length);
        for (t = 0; t < window.tables.length; t++) {
                var table = window.tables[t];
                
//get all the keys from the dictionary and put them into a list
        
        for (var h in table['rows'][0]){
            keys.push(h);
        }

        for(var i = 0; i< keys.length; i+=1){
            var optionX=document.createElement("option");
            optionX.setAttribute("value",keys[i]);
            optionX.appendChild(document.createTextNode(keys[i]));
            var optionY=optionX.cloneNode(true);
            document.getElementById("xChoose").appendChild(optionX);
            document.getElementById("yChoose").appendChild(optionY);
        }
        }
        for (i = 0; i < table['rows'].length; i++) {
             rows.push(table['rows'][i]);
             names.push(rows[i]['composition']);
        }
        console.log(names);
    });
});
});

function isUpperCase(c){
    return (c >= 'A') && (c <= 'Z')
}

function findASite(comp){
    var aSite = comp.substring(0,comp.length-4);
        if (isUpperCase(aSite.charAt(aSite.length -1))){
            aSite= aSite.substring(0,aSite.length-1);
        }
                
        else{
             aSite = aSite.substring(0,aSite.length-2);
        }
        return aSite;
}

function plot(){
  requirejs(['main'], function() {
    require(["plotly"], function(Plotly) {
        $(document).ready(function(){
          console.log(yVals.length);
          console.log(xVals.length);
          if(yVals.length != 0 && xVals.length != 0){
            var graph = document.getElementById('graph');
            var xClone = xVals.slice(0);
            var yClone = yVals.slice(0);
            var nClone = names.slice(0);
            
            Plotly.purge(graph);
            var layout = {
                margin: {t: 0},
                xaxis: {title: xTitle},
                yaxis: {title: yTitle}
            };
            var data = [];
            Plotly.newPlot(graph, [data], layout);
            
            var labels = []; var xTraces = []; var yTraces= [];
            while(names[0] != null){
                var aSite = findASite(names[0]);
                
                //make temporary lists
                var tempLabel = [];
                var tempX = [];
                var tempY = [];
                
                //put first element in the lists
                tempLabel.push(names[0]);
                tempX.push(xVals[0]);
                tempY.push(yVals[0]);
                
                //delete said element from the parent lists
                names.splice(0,1);
                xVals.splice(0,1);
                yVals.splice(0,1);
                //go through rest of list looking for matching aSites
                for(var i = 0; i < names.length; i++){
                    if( findASite(names[i]) == aSite ){
                        //push into temp lists
                        tempLabel.push(names[i]);
                        tempX.push(xVals[i]);
                        tempY.push(yVals[i]);
                        
                        //delete said element from the parent lists
                        names.splice(i,1);
                        xVals.splice(i,1);
                        yVals.splice(i,1);
                        
                        //decrement i so as to not skip values
                        i--;
                     }
                 }
                    
                    labels.push(tempLabel);
                    xTraces.push(tempX);
                    yTraces.push(tempY);

            }
            console.log(xTraces);
            console.log(yTraces);
            
            for (var i = 0; i < labels.length; i++){
                var aSite = findASite(labels[i][0]);
                
                var data = [ {
                x : xTraces[i],
                y : yTraces[i],
                text : labels[i],
                marker: {size: 10},
                mode: 'markers',
                name: aSite + "XO3",
                type: 'scatter'
                }];
               Plotly.addTraces(graph, data);
            }
            xVals=xClone;
            yVals=yClone;
            names=nClone;
          }
        });
      });
  });
}
    
        function handleXChange(){
            var select = document.getElementById("xChoose");
            xKey = select.options[select.selectedIndex].value;
            xVals = [];
            xTitle=xKey;
            for (i=0; i < rows.length; i++){
                xVals.push(rows[i][xKey]);
            }
            plot();
        }
        
        function handleYChange(){
            var select = document.getElementById("yChoose");
            yKey = select.options[select.selectedIndex].value;
            yVals = [];
            yTitle=yKey;
            for (i=0; i< rows.length; i++){
                yVals.push(rows[i][yKey]);
            }
            plot();
        }    
</script>

{% endif %}
{% endblock %}
